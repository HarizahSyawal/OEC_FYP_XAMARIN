// ===================================================================================
// Author        : System
// Created date  : 17 Aug 2020 01:45:40
// Description   : vUserRoleController class.
//
// Modified by   :
// Modified date :
// Comments      :
//
// NOTE: This file is initially generated by system and can be modified following
//       the requirement.
// ===================================================================================

using AIO.IDOS3.Data;
using AIO.IDOS3.Data.Entity;
using Microsoft.AspNet.OData;
using Microsoft.AspNet.OData.Query;
using Microsoft.AspNetCore.Mvc;
using Microsoft.Extensions.Logging;
using System;
using System.Linq;
using System.Net;
using System.Threading.Tasks;

namespace AIO.IDOS3.Web.Services.Controllers.DataServices
{

    public class vUserRolesController : DataServiceController<vUserRole>
    {

        #region Constructors
                
        public vUserRolesController(ILogger<vUserRolesController> logger, MainDbContext context)
            : base(logger, context)
        {

        }

        #endregion

        #region Methods

        [EnableQuery]
        [HttpGet]
        public IQueryable<vUserRole> Get()
        {
            var viewProvider = context.GetDataViewProvider<vUserRoleViewProvider>();

            return viewProvider.GetData();
        }
        
        [EnableQuery]
        [HttpGet]
        public async Task<IActionResult> Get([FromODataUri] int keyUserID, [FromODataUri] int keyRoleID)
        {
            var viewProvider = context.GetDataViewProvider<vUserRoleViewProvider>();

            return Ok(await viewProvider.GetDataAsync(keyUserID, keyRoleID));
        }



        [HttpPost]
        public async Task<IActionResult> Post([FromBody] vUserRole obj)
        {
            if (!ModelState.IsValid)
                return BadRequest(ModelState);

            var viewProvider = context.GetDataViewProvider<vUserRoleViewProvider>();

            using (var transaction = await context.Database.BeginTransactionAsync())
            {
                try
                {
                    await viewProvider.InsertDataAsync(obj, true);
                    await transaction.CommitAsync();
                }
                catch (Exception ex)
                {
                    await transaction.RollbackAsync();
                    throw ex;
                }
            }

            return Created(obj);
        }
        
        [HttpPatch]
        public async Task<IActionResult> Patch([FromODataUri] int keyUserID, [FromODataUri] int keyRoleID, [FromBody] vUserRole obj)
        {
            return await Put(keyUserID, keyRoleID, obj);
        }
        
        [HttpPut]
        public async Task<IActionResult> Put([FromODataUri] int keyUserID, [FromODataUri] int keyRoleID, [FromBody] vUserRole obj)
        {
            if (!ModelState.IsValid)
                return BadRequest(ModelState);

            var viewProvider = context.GetDataViewProvider<vUserRoleViewProvider>();

            obj.UserID = keyUserID;
			obj.RoleID = keyRoleID;
			
            using (var transaction = await context.Database.BeginTransactionAsync())
            {
                try
                {
                    await viewProvider.UpdateDataAsync(obj, true);
                    await transaction.CommitAsync();
                }
                catch (Exception ex)
                {
                    await transaction.RollbackAsync();
                    throw ex;
                }
            }

            return Updated(obj);
        }

        [HttpDelete]
        public async Task<IActionResult> Delete([FromODataUri] int keyUserID, [FromODataUri] int keyRoleID)
        {
            var viewProvider = context.GetDataViewProvider<vUserRoleViewProvider>();

            var obj = new vUserRole();
            obj.UserID = keyUserID;
			obj.RoleID = keyRoleID;
			
            using (var transaction = await context.Database.BeginTransactionAsync())
            {
                try
                {
                    await viewProvider.DeleteDataAsync(obj, true);
                    await transaction.CommitAsync();
                }
                catch (Exception ex)
                {
                    await transaction.RollbackAsync();
                    throw ex;
                }
            }

            return StatusCode((int)HttpStatusCode.NoContent);
        }

        #endregion

    }

}
